<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Search History</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1>Search History</h1>
    <form method="get" th:action="@{/search}">
        <div class="form-group">
            <input class="form-control" name="query" placeholder="Enter your search query" required type="text">
        </div>
        <button class="btn btn-primary" type="submit">Search</button>
    </form>
    <hr>
    <h3>Search History</h3>
    <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between align-items-center"
            th:each="search : ${searchHistory}">
            <span th:text="${search}"></span>
            <button class="btn btn-sm btn-outline-success save-btn" data-placement="top" data-toggle="tooltip"
                    title="Save"><i class="fas fa-save"></i></button>
        </li>
    </ul>

    <div th:replace="fragments/words-list :: words-list-fragment"></div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();

        $('.save-btn').click(function () {
            var searchTerm = $(this).closest('.list-group-item').find('span').text();
            // Implement your save logic here
            console.log('Saved search term:', searchTerm);
        });
    });
</script>
<div aria-hidden="true" aria-labelledby="wordModalLabel" class="modal fade" id="wordModal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="wordModalLabel">Word Details</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body"><h3 class="mb-2" id="wordText"></h3>
                <p>
                    <em class="text-muted" id="wordPhonetic"></em>
                    <button class="btn btn-link ml-2" id="audioButton">
                        <img alt="Speaker Icon" class="speaker-icon" th:src="@{/image/speaker.png}">
                    </button>
                </p>
                <div id="meaningContainer"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
</div>
</body>
<script th:inline="javascript">
    /*<![CDATA[*/
    $('#wordModal').on('shown.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var wordString = button.data('word');
         console.log(wordString)

        // Regular expressions to extract values
        var idRegex = /id=(\d+)/;
        var audioRegex = /audio='(.*?)'/;
        var textRegex = /text='(.*?)'/;
        var phoneticRegex = /phonetic='(.*?)'/;
        var isSavedRegex = /isSaved=(true|false)/;
        var meaningsRegex = /meanings=\[(.*?)}]}]/;

        // Extract values using regex
        var id = wordString.match(idRegex) ? wordString.match(idRegex)[1] : null;
        var audio = wordString.match(audioRegex) ? wordString.match(audioRegex)[1] : null;
        var text = wordString.match(textRegex) ? wordString.match(textRegex)[1] : null;
        var phonetic = wordString.match(phoneticRegex) ? wordString.match(phoneticRegex)[1] : null;
        var isSaved = wordString.match(isSavedRegex) ? wordString.match(isSavedRegex)[1] === 'true' : false;
        var meaningsString = wordString.match(meaningsRegex) ? wordString.match(meaningsRegex)[1] : null;

            console.log("meaing string ne: " + meaningsString)
        var meanings = [];
        if (meaningsString) {
            meaningsString+="}]}]"
            var meaningEntities = meaningsString.split('}, ');
            console.log("meaningEntities ne " + meaningEntities)
            meaningEntities.forEach(function(meaningEntity) {
                meaningEntity = meaningEntity.trim() + '}'; // Add '}' to complete the entity
                console.log("meaningEntity ne: " + meaningEntity);

                var idRegex = /id=(\d+)/;
                var id = meaningEntity.match(idRegex) ? meaningEntity.match(idRegex)[1] : null;

                var partOfSpeechRegex = /partOfSpeech='(.*?)'/;
                var partOfSpeech = meaningEntity.match(partOfSpeechRegex) ? meaningEntity.match(partOfSpeechRegex)[1] : null;

                var definitions = [];
                var definitionsRegex = /definitions=\[(.*?)\]/;
                var definitionsMatch = meaningEntity.match(definitionsRegex);
                if (definitionsMatch) {
                    var definitionsString = definitionsMatch[1];
                    console.log("definitionsString ne: " + definitionsString);

                    var definitionEntities = definitionsString.split('DefinitionEntity');
                    definitionEntities.forEach(function(definitionEntity) {
                        definitionEntity = definitionEntity.trim().replace(/[{}]/g, ''); // Remove '{' and '}' characters
                        var definitionIdRegex = /id=(\d+)/;
                        var definitionId = definitionEntity.match(definitionIdRegex) ? definitionEntity.match(definitionIdRegex)[1] : null;

                        var definitionRegex = /definition='(.*?)'/;
                        var definition = definitionEntity.match(definitionRegex) ? definitionEntity.match(definitionRegex)[1] : null;
                        console.log("definition ne: " + definition);

                        var exampleRegex = /example='(.*?)'/;
                        var example = definitionEntity.match(exampleRegex) ? definitionEntity.match(exampleRegex)[1] : null;

                        if (definition) {
                            definitions.push({ id: definitionId, definition: definition, example: example });
                        }
                    });
                }

                meanings.push({ id: id, partOfSpeech: partOfSpeech, definitions: definitions });
            });
        }

        var word = {
            id: id,
            audio: audio,
            text: text,
            phonetic: phonetic,
            isSaved: isSaved,
            meanings: meanings
        };

        var modal = $(this);
        modal.find('#wordText').text(word.text);
        modal.find('#wordPhonetic').text(word.phonetic);

        var audioButton = modal.find('#audioButton');
        audioButton.on('click', function() {
            var audio = new Audio(word.audio);
            audio.play();
        });

        var meaningContainer = modal.find('#meaningContainer');
        meaningContainer.empty();

        console.log(word.meanings)
        word.meanings.forEach(function (meaning) {
            var meaningElement = $('<div>').addClass('meaning');
            var partOfSpeechElement = $('<p>').addClass('part-of-speech').text('Part of Speech: ' + meaning.partOfSpeech);
            meaningElement.append(partOfSpeechElement);

            var definitionList = $('<ul>').addClass('definition-list');
            meaning.definitions.forEach(function (definition) {
                var definitionItem = $('<li>').addClass('definition-item');
                var definitionText = $('<span>').addClass('definition-text').text(definition.definition);
                var exampleText = $('<span>').addClass('example-text').text('Example: ' + definition.example);
                console.log(definitionItem)
                console.log(definitionText)
                console.log(exampleText)
                definitionItem.append(definitionText).append($('<br>')).append(exampleText);
                definitionList.append(definitionItem);
            });

            meaningElement.append(definitionList);
            meaningContainer.append(meaningElement);
        });
    });
    /*]]>*/
</script>
</html>